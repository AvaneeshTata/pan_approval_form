sap.ui.define(["sap/ui/core/mvc/ControllerExtension"],function(e){"use strict";var t;return e.extend("panapproval.ext.controller.PanDetailsObj",{override:{onInit:function(){debugger;var e=this.base.getExtensionAPI().getModel()},onBeforeRendering:async function(){debugger},onAfterRendering:async function(){debugger},routing:{onBeforeBinding:async function(e){debugger;this.getView().setVisible(false);var n=this.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].setUploadEnabled(false);var o=this;var a=window.location.href;var i=a.split("(");var g=i[1];var s=g.split("'");var r=this.base.getExtensionAPI().getModel();var l="validateUser";let d=r.bindContext(`/${l}(...)`);d.setParameter("ID",s[1]);await d.execute();debugger;let m=d.getBoundContext();let c=m.getObject();var u=JSON.parse(c.value);if(u.status=="User Found"){this.getView().setVisible(true);var p=this.base.getView().getContent()[0];function C(e){debugger;let t=sap.ui.getCore().byId(e).mAggregations.content.getContent().mAggregations.columns;t.forEach(t=>{let n=t.mProperties.dataProperty;var o=t.getHeader();var a=o.length;let i=sap.ui.getCore().byId(e).mAggregations.content.getContent().mAggregations._content.mBindingInfos.rows.binding.oCache.getAllElements();const g=Math.max(...i.map(e=>e[n]?.length??8));if(g>a)a=g;const s=a*8+20+"px";t.setWidth(s)})}p.attachSectionChange(function(){debugger;var e=this.getScrollingSectionId();if(e=="panapproval::PAN_Details_APRObjectPage--fe::FacetSection::GeneralDetails1"){C("__block1");C("__block2")}debugger;var t=sap.ui.getCore().byId(`${e}`).mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.content.mAggregations.columns;if(t!=undefined)t.forEach(t=>{let n=t.mProperties.dataProperty;let o=n.length;let a=sap.ui.getCore().byId(`${e}`).mAggregations._grid.mAggregations.content[0].mAggregations._grid.mAggregations.content[0].mAggregations.content.mAggregations.content.mAggregations._content.mBindingInfos.rows.binding.oCache.getValue();const i=Math.max(...a.map(e=>e[n]?.length??8));if(i>o)o=i;const g=o*8+20+"px";t.setWidth(g)})});var f=this.base.getAppComponent().getManifestObject()._oBaseUri._string;await $.ajax({url:f+`odata/v4/pan-approval/PAN_Details_APR/${s[1]}`,success:function(e){debugger;o.getView().getContent()[0].getFooter().setVisible(true);if(e.status=="Approved"||e.status=="Rejected"||e.status=="Justification Needed")o.getView().getContent()[0].getFooter().setVisible(false)},error:function(e,t,n){debugger;console.error(n)}});await $.ajax({url:f+`odata/v4/pan-approval/PAN_Details_APR/${s[1]}/tab1toWORKFLOW_HISTORY`,success:function(e){console.log(e);h(e)},error:function(e,t,n){console.error(n)}});function h(e){var n=e.value;var a=[];n.forEach(e=>{a.push({level:e.level,Notification_Status:e.Notification_Status,Title:e.Title,Employee_ID:e.Employee_ID,Employee_Name:e.Employee_Name,"Begin_Date/_Time":e.Begin_DateAND_Time,"End_Date/_Time":e.End_DateAND_Time,Days_Taken:e.Days_Taken,Approved_by:e.Approved_by})});let i=o.base.getView().getContent()[0].getSections()[3];let g=a.sort((e,t)=>e.level>t.level?1:e.level<t.level?-1:0);let s=[];let r=[];let l;let d;let m=g.length-1;g.forEach((e,t)=>{l=e.level;if(d!=undefined){if(l!==d){s.push(r);r=[]}}r.push(e);d=e.level;if(t==m){s.push(r)}});i.destroySubSections();i.addSubSection(new sap.uxap.ObjectPageSubSection({}));let c=i.getSubSections();let u=c[c.length-1];u.addBlock(new sap.m.ScrollContainer({horizontal:true,vertical:true,visible:true,height:"200px"}));let p=u.getBlocks()[0];p.addContent(new sap.m.HBox({width:"100%",alignItems:"End",alignContent:"End"}));let f=p.getContent();let C=f[f.length-1];C.addItem(new sap.m.HBox({width:"90%"}));C.addItem(new sap.m.Button({text:"Comment History",press:async function(e){debugger;function n(){var e=Math.floor(Math.random()*1e6);var t=(new Date).getTime();var n=t+"-"+e;return n}if(!t){t=new sap.m.Dialog({title:"Approval Comments",endButton:new sap.m.Button({text:"Close",press:async function(){debugger;t.close()},layoutData:new sap.m.FlexItemData({growFactor:5,alignSelf:"End"})})})}t.addContent(new sap.m.VBox({width:"60vw"}));let o="getcomments";let a=e.getSource().getModel().bindContext(`/${o}(...)`);console.log();var i=window.location.href;var g=i.split("(");var s=g[1];var r=s.split("'");var l=r[1];a.setParameter("ID",l);await a.execute();const d=a.getBoundContext();let m=d.getValue();m=JSON.parse(m.value);const c=[];const u=m[0];if(u==undefined){var p=new sap.suite.ui.commons.TimelineItem({text:"No Comments Found"});t.getContent()[0].destroyItems();t.getContent()[0].addItem(p)}else{m.forEach(e=>{const t=e.createdAt;const n=e.createdBy;const o=e.modifiedAt;const a=e.modifiedBy;const i=e.idd;const g=e.PAN_Number;const s=e.user;const r=e.Comments;const l=e.status;c.push({firsname:s,lname:l,comment:r,dateTime:t})});t.getContent()[0].destroyItems();for(let e=0;e<c.length;e++){debugger;var p=new sap.suite.ui.commons.TimelineItem({id:`${"item"+n()}`,dateTime:`${c[e].dateTime}`,title:`${c[e].lname}`,userNameClickable:false,userNameClicked:"onUserNameClick",select:"onPressItems",userPicture:"Photo",text:`${c[e].comment}`,userName:`${c[e].firsname}`});t.mAggregations.content[0].addItem(p)}}t.open()}}));s.forEach(e=>{p.addContent(new sap.uxap.ObjectPageSubSection({}));let t=p.getContent();let n=t[t.length-1];n.addBlock(new sap.m.VBox(`Box-${e[0].level}`));let o=n.getBlocks()[0];o.addItem(new sap.m.HBox({alignItems:"Center"}));let a=o.getItems()[0];a.addItem(new sap.m.Label({text:`Level ${e[0].level}`,design:"Bold"}));a.addItem(new sap.m.HBox({width:"40%"}));a.addItem(new sap.m.Label({text:`Notification: `}));a.addItem(new sap.m.Switch(`SwitchLevel--${e[0].level}`,{enabled:false,type:"AcceptReject",state:e[0].Notification_Status==="true",change:function(e){debugger}}));o.addItem(new sap.m.Table({visible:true}));let i=o.getItems()[1];let g=Object.keys(e[0]);g=g.slice(2);let s=[];g.forEach(e=>{if(!s.includes(e)){var t=new sap.m.Column({header:new sap.m.Label({text:e.replace(/_/g," ")}),width:"200px"});i.addColumn(t);s.push(e)}});e.forEach(e=>{let t=[];let n;let o=Object.values(e);o=o.slice(2);let a;o.forEach(e=>{a=new sap.m.Text({text:e});t.push(a)});n=new sap.m.ColumnListItem({cells:t});i.addItem(n)})})}this.getView().getContent()[0].mAggregations.sections[4].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getContent().setEditable(true);this.getView().getContent()[0].mAggregations.sections[4].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getContent().getFormContainers()[0].getFormElements()[0].getFields()[0].getContent().setEditMode("Editable");this.getView().getContent()[0].mAggregations.sections[4].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getContent().getFormContainers()[0].getFormElements()[0].getFields()[0].getContent().getContentEdit()[0].setEditable(true)}else{alert("You are Unauthorized to access this site!!")}},onAfterBinding:function(e){debugger;var t=e.oBinding.sPath;const n=/'([^']+)'/;const o=t.match(n);const a=o[1];var i=this.base.getView().getContent()[0].getSections()[2].mAggregations._grid.getContent()[0].mAggregations._grid.getContent()[0].getContent().getItems()[1].mBindingInfos.items.binding;i.filter(new sap.ui.model.Filter({path:"PAN_Number",operator:sap.ui.model.FilterOperator.EQ,value1:a}))}}}})});